name: Build ARM64 Docker Image from Another Repo

on:
  push:
    branches:
      - main  # 或者你想要触发构建的分支

jobs:
  build:
    runs-on: ubuntu-latest  # 使用 GitHub 提供的 Ubuntu 环境

    steps:
    - name: Checkout the current repo
      uses: actions/checkout@v2  # 克隆当前仓库

    - name: Clone the external repository
      run: |
        REPO_URL="https://github.com/webtor-io/self-hosted.git"  # 目标仓库 URL
        REPO_NAME=$(basename $REPO_URL .git)  # 提取仓库名
        git clone $REPO_URL  # 克隆仓库
        cd $REPO_NAME  # 进入仓库文件夹

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2  # 设置 Buildx，支持多平台构建

    - name: Set up QEMU for ARM64
      uses: docker/setup-qemu-action@v2  # 设置 QEMU，以支持 ARM64 模拟

    - name: Cache Docker layers
      uses: actions/cache@v2  # 缓存 Docker layers，避免每次构建都从头开始
      with:
        path: /tmp/.buildx-cache  # 缓存路径
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build and push ARM64 Docker image
      run: |
        docker buildx build --platform linux/arm64 -t mick2019/your-image-name:latest . --push  # 构建并推送 ARM64 镜像
